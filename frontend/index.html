<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PC Parts Chatbot</title>
  <!-- Tailwind CDN cho demo nhanh (c√≥ th·ªÉ b·ªè n·∫øu site c·ªßa b·∫°n ƒë√£ c√≥ CSS ri√™ng) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chat-shadow { box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .scroll-smooth { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-gray-50">
  <main class="min-h-screen flex items-center justify-center p-6">
    <button id="openChat" class="fixed bottom-6 right-6 rounded-full px-5 py-3 bg-black text-white text-sm font-medium chat-shadow">üí¨ H·ªó tr·ª£ linh ki·ªán</button>

    <div id="chatPanel" class="hidden fixed bottom-20 right-6 w-96 max-w-[95vw] bg-white rounded-2xl border border-gray-200 chat-shadow overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 bg-black text-white">
        <div class="font-semibold">T∆∞ v·∫•n build PC</div>
        <button id="closeChat" title="ƒê√≥ng">‚úï</button>
      </div>

      <div id="messages" class="h-96 overflow-auto p-4 space-y-3 scroll-smooth bg-gray-50">
        <div class="text-xs text-gray-500">M·∫πo: H√£y cho t√¥i bi·∫øt ng√¢n s√°ch, m·ª•c ƒë√≠ch (game/d·ª±ng phim/l·∫≠p tr√¨nh), v√† linh ki·ªán b·∫°n ƒë√£ c√≥.</div>
      </div>

      <div class="px-3 pb-3">
        <div id="suggests" class="flex gap-2 flex-wrap px-1 pb-2">
          <button class="text-xs bg-gray-200 hover:bg-gray-300 rounded-full px-3 py-1">T∆∞ v·∫•n build 20‚Äì25tr</button>
          <button class="text-xs bg-gray-200 hover:bg-gray-300 rounded-full px-3 py-1">So s√°nh i5-12400F vs R5 5600</button>
          <button class="text-xs bg-gray-200 hover:bg-gray-300 rounded-full px-3 py-1">Case mini-ITX vƒÉn ph√≤ng</button>
        </div>
        <form id="chatForm" class="flex items-center gap-2">
          <input id="userInput" class="flex-1 border rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black" placeholder="Nh·∫≠p c√¢u h·ªèi‚Ä¶" />
          <button class="rounded-xl bg-black text-white px-3 py-2 text-sm">G·ª≠i</button>
        </form>
      </div>
    </div>
  </main>

  <script>
    const backendUrl = (localStorage.getItem('chat_backend') || 'http://localhost:3001');

    const el = {
      open: document.getElementById('openChat'),
      close: document.getElementById('closeChat'),
      panel: document.getElementById('chatPanel'),
      msgs: document.getElementById('messages'),
      form: document.getElementById('chatForm'),
      input: document.getElementById('userInput'),
      suggests: document.getElementById('suggests'),
    };

    const state = {
      messages: [
        { role: 'system', content: 'B·∫°n ƒëang chat v·ªõi tr·ª£ l√Ω t∆∞ v·∫•n linh ki·ªán m√°y t√≠nh. H√£y m√¥ t·∫£ nhu c·∫ßu, ng√¢n s√°ch, game/app b·∫°n d√πng.' }
      ],
      loading: false
    };

    function mdEscape(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    function addMessage(role, content) {
      const wrap = document.createElement('div');
      wrap.className = `flex ${role==='user' ? 'justify-end' : 'justify-start'}`;
      const bubble = document.createElement('div');
      bubble.className = `max-w-[80%] whitespace-pre-wrap rounded-2xl px-3 py-2 text-sm ${role==='user' ? 'bg-black text-white' : 'bg-white border'}`;
      bubble.innerHTML = mdEscape(content);
      wrap.appendChild(bubble);
      el.msgs.appendChild(wrap);
      el.msgs.scrollTop = el.msgs.scrollHeight;
    }

    function setLoading(on){
      state.loading = on;
      if(on){ addMessage('assistant', 'ƒêang so·∫°n tr·∫£ l·ªùi‚Ä¶'); }
    }

    el.open.onclick = () => { el.panel.classList.remove('hidden'); };
    el.close.onclick = () => { el.panel.classList.add('hidden'); };

    el.suggests.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        el.input.value = e.target.textContent;
        el.input.focus();
      }
    });

    el.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = el.input.value.trim();
      if(!text || state.loading) return;
      addMessage('user', text);
      state.messages.push({ role: 'user', content: text });
      el.input.value = '';

      setLoading(true);
      try {
        const r = await fetch(`${backendUrl}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: state.messages.slice(-12) }) // g·ª≠i 12 tin g·∫ßn nh·∫•t
        });
        const data = await r.json();
        // xo√° bubble loading cu·ªëi c√πng
        el.msgs.lastChild && el.msgs.removeChild(el.msgs.lastChild);
        if (data.reply) {
          addMessage('assistant', data.reply);
          state.messages.push({ role: 'assistant', content: data.reply });
        } else {
          addMessage('assistant', 'Xin l·ªói, hi·ªán ch∆∞a tr·∫£ l·ªùi ƒë∆∞·ª£c.');
        }
      } catch (err) {
        el.msgs.lastChild && el.msgs.removeChild(el.msgs.lastChild);
        addMessage('assistant', 'L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
